<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byzantine Diatonic Synthesizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .key {
            transition: all 0.1s ease-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            user-select: none;
            cursor: pointer;
        }
        .key:active, .key.active-playing {
            transform: translateY(2px);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        /* Custom Key Colors */
        .key-pa { background-color: #a78bfa; color: white; }
        .key-vou { background-color: #8b5cf6; color: white; }
        .key-ga { background-color: #6d28d9; color: white; }
        .key-di { background-color: #9333ea; color: white; }
        .key-ke { background-color: #c084fc; color: black; }
        .key-zo { background-color: #db2777; color: white; }
        .key-ni { background-color: #f43f5e; color: white; }
        .key-pa-octave { background-color: #ef4444; color: white; }
        /* New Key Colors */
        .key-ni-low { background-color: #f43f5e; color: white; opacity: 0.7; }
        .key-vou-high { background-color: #8b5cf6; color: white; opacity: 0.7; }
        /* Soft chromatic key visuals */
        .key-softchr { background-color: #eef2ff; color: #1f2937; opacity: 0.95; border: 1px solid #c7d2fe; }

    </style>
</head>
<body class="p-4">

    <div class="max-w-4xl w-full bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 text-center">Byzantine Diatonic Keyboard</h1>
        <p class="text-center text-gray-600 mb-8">A keyboard tuned precisely to the 72-comma Byzantine Diatonic scale (Ni, to Vou').</p>

        <!-- Keyboard Display -->
        <div id="keyboard" class="flex flex-wrap justify-center gap-2 mb-8">
            <!-- Keys will be generated by JavaScript -->
        </div>

        <!-- Pitch Control and Reset Button -->
        <div class="p-4 bg-gray-100 rounded-xl border border-gray-300">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Base Pitch Control (Pa)</h2>
            
            <div class="flex items-center gap-4">
                <input type="range" id="pitch-slider" min="0" max="100" value="50" class="w-full h-2 bg-purple-300 rounded-lg appearance-none cursor-pointer range-lg">
                <span id="pitch-label" class="w-24 text-right font-mono text-base text-gray-800 font-semibold"></span>
            </div>
            
            <div class="flex items-center gap-4 mt-4">
                <label for="mode-select" class="text-sm font-semibold text-gray-700">Keyboard Mode:</label>
                <select id="mode-select" class="ml-2 rounded-md border-gray-300 px-2 py-1 text-sm">
                    <option value="diatonic">Diatonic (default)</option>
                    <option value="soft-chromatic">Soft Chromatic</option>
                </select>
            </div>
            
            <div class="flex items-center gap-4 mt-4">
                <label for="octave-drop-toggle" class="text-sm font-semibold text-gray-700">Octave Drop:</label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="octave-drop-toggle" class="w-5 h-5 rounded text-purple-600">
                    <span class="ml-2 text-sm text-gray-700">Drop 1 octave</span>
                </label>
            </div>
            
            <div class="flex items-center gap-4 mt-4">
                <label for="sticky-toggle" class="text-sm font-semibold text-gray-700">Sticky Keys:</label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="sticky-toggle" class="w-5 h-5 rounded text-purple-600">
                    <span class="ml-2 text-sm text-gray-700">Press again to release</span>
                </label>
            </div>
            
            <div class="flex justify-between items-center mt-3">
                <p class="text-xs text-gray-500">Range: One whole tone down to one whole tone up.</p>
                <button id="reset-pitch-button" class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                    Reset Pitch
                </button>
            </div>
        </div>
        <!-- End Pitch Control and Reset Button -->

        <!-- Instructions and Status -->
        <div id="status-message" class="mt-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg hidden" role="alert">
            <p class="font-bold">Audio Context Suspended</p>
            <p>Please click a key to enable sound playback.</p>
        </div>
    </div>

    <script>
        // Constants for Pitch Adjustment
        const INITIAL_BASE_FREQUENCY = 261.63; // Pa (C4) in Hz
        const WHOLE_TONE_RATIO = 9 / 8; 
        const MIN_BASE_FREQUENCY = INITIAL_BASE_FREQUENCY * (1 / WHOLE_TONE_RATIO); // Approx 232.56 Hz
        const MAX_BASE_FREQUENCY = INITIAL_BASE_FREQUENCY * WHOLE_TONE_RATIO; // Approx 294.33 Hz
        
        // GLOBAL TUNING CONSTANT: Multiplier for one comma (1/72nd of an octave)
        const COMMA_MULT_DIAT = Math.pow(2, 1 / 72); 
        const COMMA_MULT_SOFT_CHROM = Math.pow(2, 1 / 64); 
        
        // Global variables for AudioContext and keyboard setup
        let audioContext;
        let vowelWave; // Stores the custom PeriodicWave
        let isAudioReady = false;
        let currentBaseFrequency = INITIAL_BASE_FREQUENCY; // Now dynamic

        // Map to store currently playing oscillator and gain nodes for sustained playback
        const activeNotes = new Map();
        // Current keyboard mode and scale
        let currentMode = 'diatonic';
        let currentScale;
        let bodyMouseUpListenerAdded = false;
        let octaveDropActive = false;
        let stickyModeActive = false;
        const stickyNotes = new Set(); // Tracks notes that are stuck playing
        
        // Map QWERTY home row keys to scale indices
        // A, S, D, F, G, H, J, K, L â†’ 0-8 in the scale
        const QWERTY_KEYMAP = {
            'a': 0,  // Ni,
            's': 1,  // Pa
            'd': 2,  // Vou
            'f': 3,  // Ga
            'g': 4,  // Di
            'h': 5,  // Ke
            'j': 6,  // Zo
            'k': 7,  // Ni
            'l': 8,  // Pa'
            ';': 9   // Vou'
        };
        
        // Track which keyboard keys are currently pressed
        const pressedKeys = new Set();

        // Define harmonic coefficients for a rich, vowel-like sound (PeriodicWave)
        const REAL_COEFFICIENTS = new Float32Array([0, 1.0, 0.4, 0.2, 0.1, 0.05, 0.02, 0]);
        const IMAG_COEFFICIENTS = new Float32Array([0, 0, 0, 0, 0, 0, 0, 0]);

        // Detune values in cents (100 cents = 1 semitone)
        const DETUNE_VALUES = [-4, 0, 4]; 
        const BASE_VOLUME = 0.5 / DETUNE_VALUES.length; // Max volume for each voice

        // The Byzantine Diatonic Mode in the 72-comma system
        // Ratios are relative to Pa (C^0) and calculated using the COMMA_MULT_DIAT
        // Comma steps from Pa: 0, 10, 18, 30, 42, 52, 60, 72, 82. Low Ni is -12.
        const BYZANTINE_DIATONIC_SCALE = [
            { note: "Ni,", ratio: Math.pow(COMMA_MULT_DIAT, -22), class: "key-ni-low" }, // -12 commas
            { note: "Pa", ratio: Math.pow(COMMA_MULT_DIAT, -10), class: "key-pa" },      // 0 commas
            { note: "Vou", ratio: Math.pow(COMMA_MULT_DIAT, 0), class: "key-vou" },   // 10 commas
            { note: "Ga", ratio: Math.pow(COMMA_MULT_DIAT, 8), class: "key-ga" },    // 10 + 8 = 18 commas
            { note: "Di", ratio: Math.pow(COMMA_MULT_DIAT, 20), class: "key-di" },    // 18 + 12 = 30 commas
            { note: "Ke", ratio: Math.pow(COMMA_MULT_DIAT, 32), class: "key-ke" },    // 30 + 12 = 42 commas
            { note: "Zo", ratio: Math.pow(COMMA_MULT_DIAT, 42), class: "key-zo" },    // 42 + 10 = 52 commas
            { note: "Ni", ratio: Math.pow(COMMA_MULT_DIAT, 50), class: "key-ni" },    // 52 + 8 = 60 commas
            { note: "Pa'", ratio: Math.pow(COMMA_MULT_DIAT, 62), class: "key-pa-octave" }, // 60 + 12 = 72 commas
            { note: "Vou'", ratio: Math.pow(COMMA_MULT_DIAT, 72), class: "key-vou-high" } // 72 + 10 = 82 commas
        ];

        // The Byzantine Soft Chromatic Mode in 64 commas, according to https://www.patriarchalpsaltophiles.org
        const BYZANTINE_SOFT_CHROM_SCALE = [
            { note: "Ni,", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, -19), class: "key-ni-low" },
            { note: "Pa", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, -12), class: "key-pa" },
            { note: "Vou", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 0), class: "key-vou" },
            { note: "Ga", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 7), class: "key-ga" },
            { note: "Di", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 19), class: "key-di" },
            { note: "Ke", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 26), class: "key-ke" },
            { note: "Zo", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 38), class: "key-zo" },
            { note: "Ni", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 45), class: "key-ni" },
            { note: "Pa'", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 52), class: "key-pa-octave" },
            { note: "Vou'", ratio: Math.pow(COMMA_MULT_SOFT_CHROM, 64), class: "key-vou-high" }
        ];

        const keyboardContainer = document.getElementById('keyboard');
        const statusMessage = document.getElementById('status-message');
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchLabel = document.getElementById('pitch-label');
        const resetButton = document.getElementById('reset-pitch-button'); // Reference to the new button

        /**
         * Maps the slider value (0-100) linearly to the frequency range and updates global state.
         * @param {number} value - Slider value (0 to 100).
         */
        function updatePitch(value) {
            // Normalize value to 0 to 1
            const normalized = value / 100;

            // Linear interpolation to find the new frequency
            currentBaseFrequency = MIN_BASE_FREQUENCY + (MAX_BASE_FREQUENCY - MIN_BASE_FREQUENCY) * normalized;

            // Update the display label
            pitchLabel.textContent = `${currentBaseFrequency.toFixed(2)} Hz`;
        }

        /**
         * Resets the base pitch control to the initial frequency (slider value 50).
         */
        function resetPitch() {
            const defaultValue = 50;
            pitchSlider.value = defaultValue;
            updatePitch(defaultValue);
        }

        /**
         * Initializes the AudioContext and creates the custom PeriodicWave.
         */
        function initAudio() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // Create the custom waveform once
                    vowelWave = audioContext.createPeriodicWave(REAL_COEFFICIENTS, IMAG_COEFFICIENTS);
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        isAudioReady = true;
                        statusMessage.classList.add('hidden');
                        console.log('AudioContext resumed successfully');
                    }).catch(e => {
                        console.error("Failed to resume AudioContext:", e);
                        statusMessage.classList.remove('hidden');
                    });
                } else if (audioContext.state === 'running') {
                    isAudioReady = true;
                    statusMessage.classList.add('hidden');
                } else {
                     statusMessage.classList.remove('hidden');
                }

            } catch (e) {
                console.error("Web Audio API not supported in this browser:", e);
                // Custom message box for error
                document.getElementById('status-message').innerHTML = `<p class="font-bold">Error</p><p>Web Audio API not supported in this browser.</p>`;
                document.getElementById('status-message').classList.remove('bg-yellow-100', 'text-yellow-700');
                document.getElementById('status-message').classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            }
        }

        /**
         * Starts playing a note immediately on mouse down/touch start using three detuned oscillators.
         * @param {string} noteName - The name of the note (Pa, Vou, etc.).
         * @param {number} ratio - The frequency ratio relative to the base frequency.
         * @param {HTMLElement} keyElement - The key DOM element to update active state.
         */
        function startNote(noteName, ratio, keyElement) {
            initAudio();

            // In sticky mode, toggle the note on/off
            if (stickyModeActive) {
                if (stickyNotes.has(noteName)) {
                    // Note is already sticky playing, so stop it
                    stopNote(noteName);
                    return;
                } else if (activeNotes.has(noteName)) {
                    // Note is already playing (shouldn't happen in sticky mode, but handle it)
                    return;
                }
                // Mark this note as sticky
                stickyNotes.add(noteName);
            } else if (activeNotes.has(noteName)) {
                // Normal mode: prevent re-triggering the same note while holding
                return;
            }

            // Calculate dynamic frequency based on current base pitch and note ratio
            let frequency = currentBaseFrequency * ratio;
            
            // Apply octave drop if active (multiply by 0.5 for each octave down)
            if (octaveDropActive) {
                frequency *= 0.5;
            } 
            
            keyElement.classList.add('active-playing');
            const noteVoices = [];

            // --- ADSR Envelope Parameters ---
            const now = audioContext.currentTime;
            const ATTACK_TIME = 0.2; // Slower attack for a "breathy" start
            const DECAY_TIME = 0.1; // Faster decay to reach sustain sooner
            const SUSTAIN_LEVEL = 0.8; // Higher sustain volume
            const PEAK_MULT = 1.5; // Multiplier for attack peak (to make it louder than sustain)

            // Create and start the three detuned voices
            DETUNE_VALUES.forEach(cents => {
                const oscillator = audioContext.createOscillator();
                oscillator.setPeriodicWave(vowelWave);
                
                // Set the calculated frequency
                oscillator.frequency.setValueAtTime(frequency, now); 
                
                // Apply detuning in cents
                oscillator.detune.setValueAtTime(cents, now); 

                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(0.0, now);

                // Attack (A)
                gainNode.gain.linearRampToValueAtTime(BASE_VOLUME * PEAK_MULT, now + ATTACK_TIME); // Peak volume

                // Decay (D) to Sustain (S) level
                gainNode.gain.linearRampToValueAtTime(BASE_VOLUME * SUSTAIN_LEVEL, now + ATTACK_TIME + DECAY_TIME);

                // Connect and Start
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start(now);
                
                noteVoices.push({ oscillator, gainNode });
            });

            // Store the nodes and the key element so they can be stopped later
            activeNotes.set(noteName, { voices: noteVoices, keyElement: keyElement });
        }

        /**
         * Stops the note with a smooth release envelope on mouse up/touch end/mouse leave.
         * @param {string} noteName - The name of the note to stop.
         */
        function stopNote(noteName) {
            const noteData = activeNotes.get(noteName);
            if (!noteData) {
                return; // Nothing to stop
            }

            const { voices, keyElement } = noteData;
            const now = audioContext.currentTime;
            const RELEASE_TIME = 1.0; // Slightly longer release for a beautiful fade out

            keyElement.classList.remove('active-playing');

            voices.forEach(({ oscillator, gainNode }) => {
                // Apply Release (R): Ramp down to zero volume
                gainNode.gain.cancelScheduledValues(now);
                // Ensure we start the release from the current gain value
                gainNode.gain.setValueAtTime(gainNode.gain.value, now); 
                gainNode.gain.exponentialRampToValueAtTime(0.0001, now + RELEASE_TIME);

                // Stop the oscillator after the release phase is complete
                oscillator.stop(now + RELEASE_TIME + 0.1);
            });

            // Remove from the active notes map and sticky notes set
            activeNotes.delete(noteName);
            stickyNotes.delete(noteName);
        }

        /**
         * Renders the keyboard keys and attaches event listeners for continuous play.
         */
        function renderKeyboard() {
            // Clear existing keys
            keyboardContainer.innerHTML = '';

            // Use provided currentScale
            currentScale.forEach((noteData, index) => {
                const noteName = noteData.note;
                const ratio = noteData.ratio;

                const keyElement = document.createElement('div');
                keyElement.id = `key-${index}-${noteName.toLowerCase().replace(/['",\s]/g, '')}`;
                keyElement.className = `key ${noteData.class || ''} p-6 m-1 rounded-lg text-center font-semibold uppercase text-lg w-20 h-28 flex flex-col justify-end items-center transition-all duration-100 ease-in-out hover:opacity-90 active:scale-[0.98]`;
                keyElement.setAttribute('data-note', noteName);

                // Get the QWERTY key for this index
                const qwertyKeys = Object.entries(QWERTY_KEYMAP);
                const qwertyKey = qwertyKeys.find(([, idx]) => idx === index)?.[0];
                const displayKey = qwertyKey === ';' ? ';' : qwertyKey?.toUpperCase() || '';

                // Display Note Name and QWERTY Key
                keyElement.innerHTML = `
                    <span class="text-3xl font-extrabold">${noteName.replace(/'/g, '\'')}</span>
                    ${displayKey ? `<span class="text-xs opacity-60 mt-1">${displayKey}</span>` : ''}
                `;

                // --- Event Listeners for Press-and-Hold ---
                const startFunc = (e) => {
                    if (e.type === 'touchstart') e.preventDefault();
                    startNote(noteName, ratio, keyElement);
                };
                const stopFunc = () => {
                    // In sticky mode, don't auto-stop on mouseup/touchend/mouseleave
                    if (stickyModeActive) {
                        return;
                    }
                    stopNote(noteName);
                };

                keyElement.addEventListener('mousedown', startFunc);
                keyElement.addEventListener('touchstart', startFunc);
                keyElement.addEventListener('mouseup', stopFunc);
                keyElement.addEventListener('touchend', stopFunc);
                keyElement.addEventListener('mouseleave', stopFunc);

                keyboardContainer.appendChild(keyElement);
            });

            // Attach body mouseup listener only once to avoid duplicates
            if (!bodyMouseUpListenerAdded) {
                document.body.addEventListener('mouseup', (e) => {
                    if (!e.target.closest('.key')) {
                        // Stop all active notes
                        Array.from(activeNotes.keys()).forEach(noteName => stopNote(noteName));
                    }
                });
                bodyMouseUpListenerAdded = true;
            }
        }

        /**
         * Switch keyboard mode and re-render keys.
         */
        function setMode(mode) {
            // Stop any playing notes
            Array.from(activeNotes.keys()).forEach(noteName => stopNote(noteName));
            // Clear sticky notes
            stickyNotes.clear();

            if (mode === 'soft-chromatic') {
                currentScale = BYZANTINE_SOFT_CHROM_SCALE;
            } else {
                currentScale = BYZANTINE_DIATONIC_SCALE;
            }
            currentMode = mode;
            renderKeyboard();
        }

        /**
         * Handles keyboard keydown events for QWERTY home row keys (A-L).
         */
        function handleKeyDown(e) {
            const key = e.key.toLowerCase();
            
            // Only process if it's a mapped QWERTY key and not already pressed
            if (QWERTY_KEYMAP.hasOwnProperty(key) && !pressedKeys.has(key)) {
                e.preventDefault();
                pressedKeys.add(key);
                
                const scaleIndex = QWERTY_KEYMAP[key];
                if (scaleIndex < currentScale.length) {
                    const noteData = currentScale[scaleIndex];
                    const keyElement = document.getElementById(`key-${scaleIndex}-${noteData.note.toLowerCase().replace(/['",\s]/g, '')}`);
                    if (keyElement) {
                        startNote(noteData.note, noteData.ratio, keyElement);
                    }
                }
            }
        }

        /**
         * Handles keyboard keyup events for QWERTY home row keys (A-L).
         */
        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            
            // Only process if it's a mapped QWERTY key
            if (QWERTY_KEYMAP.hasOwnProperty(key) && pressedKeys.has(key)) {
                e.preventDefault();
                pressedKeys.delete(key);
                
                // In sticky mode, don't auto-stop on key release
                if (stickyModeActive) {
                    return;
                }
                
                const scaleIndex = QWERTY_KEYMAP[key];
                if (scaleIndex < currentScale.length) {
                    const noteData = currentScale[scaleIndex];
                    stopNote(noteData.note);
                }
            }
        }

        // Initialize status message and pitch control on load
        window.onload = function() {
            // Set initial pitch value and display label
            updatePitch(pitchSlider.value); 
            
            // Add listener for pitch adjustments
            pitchSlider.addEventListener('input', (e) => {
                updatePitch(e.target.value);
            });
            
            // Add listener for reset button
            resetButton.addEventListener('click', resetPitch);
            
            // Mode selector handling
            const modeSelect = document.getElementById('mode-select');
            if (modeSelect) {
                modeSelect.addEventListener('change', (e) => {
                    setMode(e.target.value);
                });
            }
            
            // Octave drop toggle handling
            const octaveDropToggle = document.getElementById('octave-drop-toggle');
            if (octaveDropToggle) {
                octaveDropToggle.addEventListener('change', (e) => {
                    octaveDropActive = e.target.checked;
                });
            }
            
            // Sticky keys toggle handling
            const stickyToggle = document.getElementById('sticky-toggle');
            if (stickyToggle) {
                stickyToggle.addEventListener('change', (e) => {
                    stickyModeActive = e.target.checked;
                    // Clear all sticky notes when toggling off
                    if (!stickyModeActive) {
                        Array.from(stickyNotes).forEach(noteName => stopNote(noteName));
                    }
                });
            }
            
            // Add keyboard event listeners for QWERTY home row
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            if (window.AudioContext || window.webkitAudioContext) {
                statusMessage.classList.remove('hidden');
                // Render initial keyboard for default mode
                setMode(currentMode);
            } else {
                statusMessage.innerHTML = `<p class="font-bold">Error</p><p>Your browser does not support the Web Audio API required for this app.</p>`;
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('bg-yellow-100');
                statusMessage.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            }
        };

    </script>
</body>
</html>
